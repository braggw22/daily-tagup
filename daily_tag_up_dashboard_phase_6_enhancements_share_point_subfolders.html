<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Daily Tag-Up Dashboard — Phase 6 (Enhancements + SharePoint Subfolders)</title>
<style>
  :root{
    --bg:#0d1117; --panel:#0f172a; --panel-2:#111827; --text:#e5e7eb; --muted:#9ca3af;
    --accent-1:#0b3b6e; --accent-2:#1581a6; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    --shadow:0 10px 24px rgba(0,0,0,.35); --radius:14px; --lane:#0b1222; --lane-b:#1f2937;
    --card:#0f172a; --card-b:#233048; --btn:#0f172a; --btn-b:#263247; --field:#0b1222; --field-b:#2a3856;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));padding:12px 16px;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow);position:sticky;top:0;z-index:7}
  .status-badge{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.25)}
  .status-badge.ready{background:rgba(16,185,129,.25);border-color:rgba(16,185,129,.5)}
  .status-badge.loading{background:rgba(245,158,11,.25);border-color:rgba(245,158,11,.6)}
  .toolbar{display:flex;gap:8px;align-items:center}
  .btn{appearance:none;border:1px solid var(--btn-b);color:var(--text);background:var(--btn);border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn:hover{border-color:#3b82f6}
  input[type=file]{display:none}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #334155;background:#0b162a;font-size:12px}

  .app{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 58px)}
  aside{background:linear-gradient(180deg,#0c1222,#0a0f1b);border-right:1px solid #1f2937;padding:14px}
  .nav{display:flex;flex-direction:column;gap:8px}
  .nav button{border:1px solid #1f2937;background:linear-gradient(180deg,#0f172a,#0b1222);color:var(--text);border-radius:10px;padding:10px 12px;text-align:left;cursor:pointer}
  .nav button.active{border-color:#3b82f6;box-shadow:inset 0 0 0 1px rgba(59,130,246,.35)}
  .note{color:var(--muted);font-size:12px}

  main{padding:16px;background:radial-gradient(1200px 600px at 80% -10%,rgba(21,129,166,.08),transparent 60%),radial-gradient(900px 400px at 10% 110%,rgba(11,59,110,.12),transparent 60%)}
  .view{display:none;background:var(--panel-2);border:1px solid #1f2937;border-radius:var(--radius);padding:12px;box-shadow:var(--shadow);min-height:320px}
  .view.active{display:block}

  .members{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 12px}
  .member{border:1px solid var(--lane-b);background:#0a1324;border-radius:10px;padding:8px 10px;display:flex;gap:8px;align-items:center;min-width:170px}
  .avatar{width:24px;height:24px;border-radius:999px;background:#24304a;display:grid;place-items:center;font-weight:700;border:1px solid #2f3d5c;font-size:12px}

  .lanes{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
  .lane{background:var(--lane);border:1px solid var(--lane-b);border-radius:12px;padding:10px;min-height:240px}
  .lane-header{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;margin-bottom:6px}
  .cards{display:flex;flex-direction:column;gap:8px}
  .card{background:var(--card);border:1px solid var(--card-b);border-radius:10px;padding:8px;cursor:grab}
  .t{font-weight:600}
  .meta{color:var(--muted);font-size:11px;margin-top:4px;display:flex;gap:8px;flex-wrap:wrap}
  .tag{padding:2px 6px;border-radius:999px;border:1px solid #334155;background:#0b162a;font-size:11px}
  .prio-low{border-color:#2dd4bf}.prio-normal{border-color:#60a5fa}.prio-high{border-color:#f59e0b}.prio-critical{border-color:#ef4444}

  .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .filters input[type=text], .filters select{padding:8px 10px;border-radius:10px;border:1px solid var(--field-b);background:var(--field);color:var(--text)}
  .backlog-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}

  .cal-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cal-weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:6px;color:var(--muted);font-size:12px}
  .cal-cell{min-height:100px;background:#0a1224;border:1px solid #1e2b46;border-radius:10px;padding:6px;display:flex;flex-direction:column;gap:6px}
  .cal-cell .d{font-size:12px;color:var(--muted)}
  .event{display:inline-flex;align-items:center;gap:6px;padding:4px 6px;border-radius:999px;border:1px solid #334155;background:#0b162a;font-size:11px;cursor:grab}
  .event .dot{width:8px;height:8px;border-radius:999px;background:#60a5fa;display:inline-block}
  .event.critical .dot{background:#ef4444}.event.high .dot{background:#f59e0b}.event.low .dot{background:#2dd4bf}

  .row{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:10px}
  .row .col-2{grid-column:span 2}.row .col-3{grid-column:span 3}.row .col-6{grid-column:span 6}
  input[type=text],input[type=date],textarea,select{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--field-b);background:var(--field);color:var(--text)}
  textarea{min-height:96px;resize:vertical}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;white-space:pre-wrap;background:#0b1222;border:1px solid #2a3856;border-radius:10px;padding:10px}
  .grid-table{width:100%;border-collapse:collapse}
  .grid-table th,.grid-table td{border:1px solid #2b3a58;padding:8px 10px;vertical-align:top}
  .grid-table th{background:#0c162c;color:#d1d5db}
  .ok{color:var(--ok)}.warn{color:var(--warn)}.err{color:var(--err)}

  /* Milestones */
  .ms-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
  .ms-card{background:var(--card);border:1px solid var(--card-b);border-radius:10px;padding:10px}
  .bar{height:8px;background:#0a1224;border:1px solid #24334e;border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%;background:#22d3ee}
</style>
</head>
<body>
<header>
  <div class="title">Daily Tag-Up Dashboard</div>
  <div class="toolbar">
    <button class="btn" id="btnQuickTask">+ Quick Task</button>
    <button class="btn" id="btnExport">Export JSON</button>
    <label class="btn">Import JSON <input type="file" id="fileImport" accept="application/json"></label>
    <label class="btn">Import Schedule (.csv/.json) <input type="file" id="fileSchedule" accept=".csv,application/json"></label>
    <div id="statusBadge" class="status-badge loading" role="status" aria-live="polite">loading…</div>
  </div>
</header>
<div class="app">
  <aside>
    <div class="nav" id="nav">
      <button data-view="dashboard" class="active">Dashboard</button>
      <button data-view="backlog">Backlog</button>
      <button data-view="tagup">Daily Tag-Up</button>
      <button data-view="calendar">Calendar</button>
      <button data-view="team">Team Dashboard</button>
      <button data-view="milestones">Milestones</button>
      <button data-view="config">Config</button>
    </div>
    <p class="note" style="margin:10px 0 0">If buttons don’t click, Unblock the file (Properties → Unblock) or:<br><code>Unblock-File -Path ".\index.html"</code></p>
  </aside>
  <main>
    <section id="view-dashboard" class="view active">
      <h2>Dashboard</h2>
      <div class="members" id="memberStrip"></div>
      <div class="lanes" id="kanban"></div>
    </section>

    <section id="view-backlog" class="view">
      <h2>Backlog</h2>
      <div class="filters">
        <input type="text" id="searchInput" placeholder="Search title/site/building">
        <select id="sortSelect">
          <option value="priority">Sort: priority</option>
          <option value="due">Sort: due date</option>
          <option value="title">Sort: title</option>
        </select>
      </div>
      <div class="members" id="assignStrip"></div>
      <div class="backlog-list" id="backlogList"></div>
    </section>

    <section id="view-tagup" class="view">
      <h2>Daily Tag-Up</h2>
      <div class="row">
        <div class="col-2"><label>Date<input type="date" id="tagDate"></label></div>
        <div class="col-2"><label>Mode<select id="modeSelect"><option value="team">Team summary</option><option value="person">Per-person</option></select></label></div>
        <div class="col-2" id="personWrap" style="display:none"><label>Person<select id="personSelect"></select></label></div>
        <div class="col-3"><label>TO<input type="text" id="toInput" placeholder="comma-separated emails"></label></div>
        <div class="col-3"><label>CC<input type="text" id="ccInput" placeholder="comma-separated emails"></label></div>
      </div>
      <div class="row"><div class="col-6"><label>1) Yesterday<textarea id="yesterdayArea"></textarea></label></div></div>
      <div class="row"><div class="col-6"><label>2) Today<textarea id="todayArea"></textarea></label></div></div>
      <div class="row"><div class="col-6"><label>3) Blockers<textarea id="blockersArea"></textarea></label></div></div>
      <div class="row"><div class="col-6"><span class="chip" id="folderChip">Folder: (not set)</span></div></div>
      <div class="row"><div class="col-6">
        <button class="btn" id="btnAutofill">Auto-fill</button>
        <button class="btn" id="btnSaveDraft">Save Draft</button>
        <button class="btn" id="btnBuildEmail">Build Preview</button>
        <button class="btn" id="btnDownloadTxt">Download .txt</button>
        <button class="btn" id="btnSubmitFolder">Submit to Shared Folder</button>
        <button class="btn" id="btnEnsureDay">Ensure Today Subfolder</button>
      </div></div>
      <h3 style="margin:10px 0 6px">Generated</h3>
      <div class="mono" id="emailPreview"></div>
    </section>

    <section id="view-calendar" class="view">
      <h2>Calendar</h2>
      <div class="cal-header">
        <div>
          <button class="btn" id="calPrev">&larr; Prev</button>
          <button class="btn" id="calToday">Today</button>
          <button class="btn" id="calNext">Next &rarr;</button>
        </div>
        <div id="calTitle" style="font-weight:600"></div>
      </div>
      <div class="cal-weekdays"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
      <div class="cal-grid" id="calGrid"></div>
    </section>

    <section id="view-team" class="view">
      <h2>Team Dashboard</h2>
      <div class="row">
        <div class="col-6">
          <button class="btn" id="btnPickFolder">Set/Change Shared Folder</button>
          <button class="btn" id="btnRefreshFolder">Refresh Submissions</button>
          <label class="btn">Load JSONs (fallback) <input type="file" id="multiJson" accept="application/json" multiple></label>
        </div>
      </div>
      <div class="row"><div class="col-6"><span class="chip" id="teamFolderChip">Folder: (not set)</span></div></div>
      <div id="teamSummaryCounts" class="note" style="margin:6px 0 10px"></div>
      <div style="overflow:auto"><table class="grid-table" id="teamTable"><thead><tr><th>Member</th><th>Yesterday</th><th>Today</th><th>Blockers</th><th>Date</th><th>Status</th></tr></thead><tbody></tbody></table></div>
      <h3 style="margin:10px 8px 6px">Risks & Impediments</h3>
      <div class="note" style="margin:0 8px 8px">(L/M/H severity; inline editable)</div>
      <div style="overflow:auto;margin:0 8px 8px">
        <table class="grid-table" id="riskTable"><thead><tr><th>Risk / Issue</th><th>Severity</th><th>Owner</th><th>Status</th><th>Mitigation</th><th>Actions</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="row"><div class="col-6">
        <button class="btn" id="btnAddRisk">+ Add Risk</button>
        <button class="btn" id="btnBuildTeamTxt">Build Team Summary</button>
        <button class="btn" id="btnDownloadTeamTxt">Download Team .txt</button>
      </div></div>
      <div class="mono" id="teamTxtPreview" style="margin-top:10px"></div>
    </section>

    <section id="view-milestones" class="view">
      <h2>Milestones</h2>
      <div class="row">
        <div class="col-6">
          <button class="btn" id="btnAddMs">+ Add Milestone</button>
          <button class="btn" id="btnExportMs">Export Milestones JSON</button>
          <label class="btn">Import Milestones <input type="file" id="fileImportMs" accept="application/json"></label>
        </div>
      </div>
      <div class="ms-list" id="msList"></div>
    </section>

    <section id="view-config" class="view">
      <h2>Config</h2>
      <div class="row">
        <div class="col-3"><label>Your Display Name<input type="text" id="cfgDisplayName" placeholder="e.g., Weston Bragg"></label></div>
        <div class="col-3"><label>Your Short ID<input type="text" id="cfgShortId" placeholder="e.g., WBragg"></label></div>
      </div>
      <div class="row"><div class="col-6">
        <button class="btn" id="cfgPickFolder">Choose Shared Folder</button>
        <span class="chip" id="cfgFolderName">(none)</span>
      </div></div>
      <div class="row"><div class="col-6">
        <button class="btn" id="cfgSave">Save Config</button> <span class="chip" id="cfgSaved" style="display:none">Saved</span>
      </div></div>
      <p class="note">Folder permission persists locally (IndexedDB). If the browser clears site data, reselect the folder once.</p>
    </section>
  </main>
</div>

<!-- Modal for Task -->
<div class="modal" id="taskModal" style="position:fixed;inset:0;background:rgba(2,6,23,.6);display:none;align-items:center;justify-content:center;z-index:10">
  <div style="width:min(880px,92vw);background:#0d1426;border:1px solid #243049;border-radius:14px;padding:14px">
    <h3 style="margin:0 0 10px">Task</h3>
    <form id="taskForm">
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px">
        <div style="grid-column:span 4"><label>Title<input name="title" required></label></div>
        <div style="grid-column:span 4"><label>Description<textarea name="description" style="min-height:80px"></textarea></label></div>
        <div style="grid-column:span 2"><label>Assignee<select name="assignee_id" id="assigneeSel"></select></label></div>
        <div style="grid-column:span 2"><label>Status<select name="status" id="statusSel"><option>backlog</option><option>in_progress</option><option>blocked</option><option>review</option><option>done</option></select></label></div>
        <div><label>Priority<select name="priority"><option>normal</option><option>low</option><option>high</option><option>critical</option></select></label></div>
        <div><label>Start Date<input type="date" name="start_date"></label></div>
        <div><label>Due Date<input type="date" name="due_date"></label></div>
        <div><label>Project<input name="project" value="DO-0117"></label></div>
        <div><label>Site<input name="site"></label></div>
        <div><label>Building<input name="building"></label></div>
        <div style="grid-column:span 4"><label>Links (comma-separated URLs)<input name="links" placeholder="https://…"></label></div>
      </div>
      <input type="hidden" name="task_id" id="taskHiddenId">
      <div style="display:flex;justify-content:space-between;margin-top:12px">
        <button type="button" class="btn" id="btnCancel">Cancel</button>
        <div style="display:flex;gap:8px"><button type="button" class="btn" id="btnDelete">Delete</button><button class="btn" id="btnSave">Save Task</button></div>
      </div>
    </form>
  </div>
</div>

<script>
'use strict';
document.addEventListener('DOMContentLoaded', function(){
  try{
    const statusBadge = document.getElementById('statusBadge');
    const nav = document.getElementById('nav');
    const byId = (id)=>document.getElementById(id);
    const esc = (s)=> (s||'').replace(/[&<>"']/g, (c)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    const z2 = (n)=> String(n).padStart(2,'0');
    const fmtDate = (d)=> d.getFullYear()+'-'+z2(d.getMonth()+1)+'-'+z2(d.getDate());
    const todayISO = fmtDate(new Date());

    // ===== State & Storage =====
    const STORAGE_KEY='DTDASH_V6';
    const TAGUP_KEY='DTDASH_V6_TAGUPS';
    const CFG_KEY='DTDASH_V6_CFG';
    const MS_KEY='DTDASH_V6_MS';
    const RISK_KEY='DTDASH_V6_RISKS';
    const state={members:[
      {id:'m_wb',name:'Weston Bragg',role:'Installations Engineer'},
      {id:'m_bb',name:'Brian Burrer',role:'Engineer'},
      {id:'m_cc',name:'Chase Cole',role:'Engineer'},
      {id:'m_gl',name:'Gavin Lasater',role:'Engineer'},
      {id:'m_hc',name:'Holocom (Subcontractor)',role:'Subcontractor'}
    ], tasks:[]};
    function loadLS(k,def){ try{ return JSON.parse(localStorage.getItem(k)||def);}catch(_){return JSON.parse(def);} }
    function saveLS(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){} }
    (function loadAll(){ const raw=loadLS(STORAGE_KEY,'{}'); if(raw.members) state.members=raw.members; if(raw.tasks) state.tasks=raw.tasks; })();
    const cfg = loadLS(CFG_KEY,'{}')||{}; // {displayName, shortId}
    let milestones = loadLS(MS_KEY,'[]')||[];
    let risks = loadLS(RISK_KEY,'[]')||[];

    // ===== Views map =====
    const views={
      dashboard:byId('view-dashboard'), backlog:byId('view-backlog'), tagup:byId('view-tagup'),
      calendar:byId('view-calendar'), team:byId('view-team'), milestones:byId('view-milestones'), config:byId('view-config')
    };
    function activateView(key){
      nav.querySelectorAll('button[data-view]').forEach(b=> b.classList.toggle('active', b.dataset.view===key));
      Object.keys(views).forEach(k=> views[k].classList.toggle('active', k===key));
      if(key==='team') refreshFolder();
      if(key==='milestones') renderMilestones();
      if(key==='config') hydrateConfigUI();
    }
    nav.addEventListener('click', (e)=>{ const btn=e.target.closest && e.target.closest('button[data-view]'); if(btn){ activateView(btn.dataset.view); } });
    window.addEventListener('hashchange', ()=>{ const key=(location.hash||'#dashboard').slice(1); if(views[key]) activateView(key); });

    // ===== Members UI =====
    function renderMembers(into){ into.innerHTML=''; state.members.forEach(m=>{ const el=document.createElement('div'); el.className='member'; el.setAttribute('data-member-id',m.id); const initials=m.name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase(); el.innerHTML=`<div class="avatar">${initials}</div><div><div class="name">${esc(m.name)}</div><div class="note">${esc(m.role||'')}</div></div>`; into.appendChild(el); }); }

    // ===== Kanban =====
    const lanesOrder=['backlog','in_progress','blocked','review','done'];
    const prioClass={low:'prio-low',normal:'prio-normal',high:'prio-high',critical:'prio-critical'};
    function cardHTML(t){ const m=state.members.find(x=>x.id===t.assignee_id); const p=prioClass[t.priority||'normal']||'prio-normal'; return `<div class="card" draggable="true" data-task-id="${t.id}"><div class="t">${esc(t.title||'Untitled')}</div><div class="meta"><span class="tag ${p}">${esc(t.priority||'normal')}</span><span class="tag">${esc(m?m.name:'Unassigned')}</span>${t.site?`<span class="tag">Site: ${esc(t.site)}</span>`:''}${t.building?`<span class="tag">Bldg: ${esc(t.building)}</span>`:''}${t.due_date?`<span class="tag">Due: ${esc(t.due_date)}</span>`:''}</div></div>`; }
    function renderKanban(){ const wrap=byId('kanban'); wrap.innerHTML=''; lanesOrder.forEach(s=>{ const tasks=state.tasks.filter(t=>t.status===s); const lane=document.createElement('div'); lane.className='lane'; lane.setAttribute('data-status',s); lane.innerHTML=`<div class="lane-header"><span>${s.replace('_',' ')}</span><span class="count">${tasks.length}</span></div><div class="cards"></div>`; const cards=lane.querySelector('.cards'); tasks.forEach(t=> cards.insertAdjacentHTML('beforeend', cardHTML(t))); wrap.appendChild(lane); }); enableLaneDrops(); }

    // ===== Backlog =====
    function renderBacklog(){ renderMembers(byId('assignStrip')); const list=byId('backlogList'); const q=(byId('searchInput').value||'').toLowerCase().trim(); const sortBy=byId('sortSelect').value; let items=state.tasks.filter(t=>t.status==='backlog'); if(q){ items=items.filter(t=> (t.title||'').toLowerCase().includes(q) || (t.site||'').toLowerCase().includes(q) || (t.building||'').toLowerCase().includes(q)); } if(sortBy==='title'){ items.sort((a,b)=> (a.title||'').localeCompare(b.title||'')); } else if(sortBy==='due'){ items.sort((a,b)=> (a.due_date||'').localeCompare(b.due_date||'')); } else { const order={critical:0,high:1,normal:2,low:3}; items.sort((a,b)=> (order[a.priority||'normal']??9)-(order[b.priority||'normal']??9)); } list.innerHTML=''; items.forEach(t=>{ const m=state.members.find(x=>x.id===t.assignee_id); const p=prioClass[t.priority||'normal']||'prio-normal'; const el=document.createElement('div'); el.className='card'; el.setAttribute('draggable','true'); el.setAttribute('data-task-id',t.id); el.innerHTML=`<div class="t">${esc(t.title||'Untitled')}</div><div class="meta"><span class="tag ${p}">${esc(t.priority||'normal')}</span><span class="tag">${esc(m?m.name:'Unassigned')}</span>${t.site?`<span class="tag">Site: ${esc(t.site)}</span>`:''}${t.building?`<span class="tag">Bldg: ${esc(t.building)}</span>`:''}${t.due_date?`<span class="tag">Due: ${esc(t.due_date)}</span>`:''}</div>`; list.appendChild(el); }); enableMemberDrops('#assignStrip .member'); }

    // ===== Calendar =====
    let calCursor=new Date();
    function renderCalendar(){ const names=['January','February','March','April','May','June','July','August','September','October','November','December']; byId('calTitle').textContent=names[calCursor.getMonth()]+' '+calCursor.getFullYear(); const grid=byId('calGrid'); grid.innerHTML=''; const first=new Date(calCursor.getFullYear(),calCursor.getMonth(),1); const startDay=first.getDay(); const days=new Date(calCursor.getFullYear(),calCursor.getMonth()+1,0).getDate(); const total=Math.ceil((startDay+days)/7)*7; for(let i=0;i<total;i++){ const cell=document.createElement('div'); cell.className='cal-cell'; const day=i-startDay+1; if(day<1||day>days){ cell.style.opacity=.3; cell.innerHTML='<div class="d">&nbsp;</div>'; grid.appendChild(cell); continue;} const d=new Date(calCursor.getFullYear(),calCursor.getMonth(),day); const iso=fmtDate(d); cell.setAttribute('data-date',iso); cell.innerHTML=`<div class="d">${day}</div>`; state.tasks.filter(t=>t.due_date===iso).forEach(t=>{ const chip=document.createElement('div'); chip.className=`event ${t.priority||'normal'}`; chip.setAttribute('draggable','true'); chip.setAttribute('data-task-id',t.id); chip.innerHTML='<span class="dot"></span><span>'+esc(t.title||'Untitled')+'</span>'; cell.appendChild(chip); }); grid.appendChild(cell);} enableCalendarDrops(); }

    // ===== Drag & Drop =====
    let dragId=null;
    document.addEventListener('dragstart', (e)=>{ const el=e.target.closest && (e.target.closest('.card[data-task-id]')||e.target.closest('.event[data-task-id]')); if(el){ dragId=el.getAttribute('data-task-id'); e.dataTransfer.setData('text/plain',dragId); e.dataTransfer.effectAllowed='move'; }});
    document.addEventListener('dragend', ()=>{ dragId=null; document.querySelectorAll('[data-drop="true"]').forEach(n=>n.removeAttribute('data-drop')); });
    function enableLaneDrops(){ document.querySelectorAll('.lane').forEach(l=>{ l.addEventListener('dragover',(e)=>{ if(dragId){ e.preventDefault(); l.setAttribute('data-drop','true'); } }); l.addEventListener('dragleave',()=>l.removeAttribute('data-drop')); l.addEventListener('drop',(e)=>{ e.preventDefault(); l.removeAttribute('data-drop'); const t=state.tasks.find(x=>x.id===dragId); if(!t) return; t.status=l.getAttribute('data-status'); save(); renderAll(); }); }); }
    function enableMemberDrops(sel){ document.querySelectorAll(sel).forEach(mem=>{ mem.addEventListener('dragover',(e)=>{ if(dragId){ e.preventDefault(); mem.setAttribute('data-drop','true'); } }); mem.addEventListener('dragleave',()=>mem.removeAttribute('data-drop')); mem.addEventListener('drop',(e)=>{ e.preventDefault(); mem.removeAttribute('data-drop'); const t=state.tasks.find(x=>x.id===dragId); if(!t) return; t.assignee_id=mem.getAttribute('data-member-id')||''; if(t.status==='backlog') t.status='in_progress'; save(); renderAll(); }); }); }
    function enableCalendarDrops(){ document.querySelectorAll('.cal-cell[data-date]').forEach(cell=>{ cell.addEventListener('dragover',(e)=>{ if(dragId){ e.preventDefault(); cell.setAttribute('data-drop','true'); } }); cell.addEventListener('dragleave',()=>cell.removeAttribute('data-drop')); cell.addEventListener('drop',(e)=>{ e.preventDefault(); cell.removeAttribute('data-drop'); const t=state.tasks.find(x=>x.id===dragId); if(!t) return; t.due_date=cell.getAttribute('data-date'); save(); renderAll(); }); }); }

    // ===== Task Modal =====
    const taskModal=byId('taskModal'); const taskForm=byId('taskForm'); const hiddenId=byId('taskHiddenId'); const assigneeSel=byId('assigneeSel');
    function fillAssigneeSelect(){ assigneeSel.innerHTML='<option value="">(unassigned)</option>'; state.members.forEach(m=>{ const o=document.createElement('option'); o.value=m.id; o.textContent=m.name; assigneeSel.appendChild(o); }); }
    function openModal(task){ taskModal.style.display='flex'; fillAssigneeSelect(); if(task){ hiddenId.value=task.id; taskForm.title.value=task.title||''; taskForm.description.value=task.description||''; taskForm.assignee_id.value=task.assignee_id||''; taskForm.status.value=task.status||'backlog'; taskForm.priority.value=task.priority||'normal'; taskForm.start_date.value=task.start_date||''; taskForm.due_date.value=task.due_date||''; taskForm.project.value=task.project||'DO-0117'; taskForm.site.value=task.site||''; taskForm.building.value=task.building||''; taskForm.links.value=Array.isArray(task.links)?task.links.join(', '):''; } else { taskForm.reset(); hiddenId.value=''; taskForm.project.value='DO-0117'; taskForm.status.value='backlog'; taskForm.priority.value='normal'; } }
    function closeModal(){ taskModal.style.display='none'; }
    byId('btnCancel').addEventListener('click', closeModal);
    byId('btnQuickTask').addEventListener('click', ()=>openModal(null));
    byId('btnDelete').addEventListener('click', ()=>{ const id=hiddenId.value; if(id){ state.tasks=state.tasks.filter(t=>t.id!==id); save(); renderAll(); } closeModal(); });
    byId('btnSave').addEventListener('click', (e)=>{ e.preventDefault(); const t={ id:hiddenId.value || ('t_'+Math.random().toString(36).slice(2,9)+Date.now().toString(36)), title:taskForm.title.value.trim()||'Untitled', description:taskForm.description.value.trim(), assignee_id:taskForm.assignee_id.value||'', status:taskForm.status.value||'backlog', priority:taskForm.priority.value||'normal', start_date:taskForm.start_date.value||'', due_date:taskForm.due_date.value||'', project:taskForm.project.value.trim()||'DO-0117', site:taskForm.site.value.trim(), building:taskForm.building.value.trim(), links:(taskForm.links.value||'').split(',').map(s=>s.trim()).filter(Boolean) }; const i=state.tasks.findIndex(x=>x.id===t.id); if(i>=0) state.tasks[i]=t; else state.tasks.push(t); save(); renderAll(); closeModal(); });

    // ===== Export/Import dataset =====
    function save(){ saveLS(STORAGE_KEY,state); }
    byId('btnExport').addEventListener('click', ()=>{ const blob=new Blob([JSON.stringify({members:state.members,tasks:state.tasks,milestones,risks},null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='daily-tagup-data.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500); });
    byId('fileImport').addEventListener('change', ()=>{ const f=byId('fileImport').files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const d=JSON.parse(r.result); if(d.members) state.members=d.members; if(d.tasks) state.tasks=d.tasks; if(d.milestones) milestones=d.milestones; if(d.risks) risks=d.risks; save(); saveLS(MS_KEY,milestones); saveLS(RISK_KEY,risks); renderAll(); }catch(_){ } }; r.readAsText(f); byId('fileImport').value=''; });

    // ===== Schedule Import (.csv/.json) → tasks mapping =====
    byId('fileSchedule').addEventListener('change', async ()=>{ const f=byId('fileSchedule').files[0]; if(!f) return; const text=await f.text(); try{ let rows=[]; if(f.name.toLowerCase().endsWith('.json')){ const js=JSON.parse(text); if(Array.isArray(js)) rows=js; } else { // simple CSV parser
        rows=text.split(/\r?\n/).filter(Boolean).map(l=>l.split(',').map(s=>s.trim())); const header=rows.shift(); rows=rows.map(cols=>{ const obj={}; header.forEach((h,i)=>obj[h]=cols[i]); return obj; }); }
      const mapField=(o,keys)=>{ for(const k of keys){ if(o[k]!==undefined && o[k]!==null && String(o[k]).trim()!=='') return String(o[k]).trim(); } return ''; };
      rows.forEach(o=>{ const t={ id:'t_'+Math.random().toString(36).slice(2,9)+Date.now().toString(36), title:mapField(o,['Task','Task Name','Title','Summary','Name'])||'Imported Task', description:mapField(o,['Description','Notes'])||'', assignee_id:'', status:'backlog', priority:(mapField(o,['Priority']).toLowerCase()||'normal'), start_date:mapField(o,['Start','Start Date']), due_date:mapField(o,['Due','Due Date','Finish']), project:mapField(o,['Project'])||'DO-0117', site:mapField(o,['Site']), building:mapField(o,['Building']), links:[] }; state.tasks.push(t); }); save(); renderAll(); }catch(_){ /* ignore */ } byId('fileSchedule').value=''; });

    // ===== Tag-Up =====
    const tagDate=byId('tagDate'); const modeSelect=byId('modeSelect'); const personWrap=byId('personWrap'); const personSelect=byId('personSelect'); const toInput=byId('toInput'); const ccInput=byId('ccInput'); const yesterdayArea=byId('yesterdayArea'); const todayArea=byId('todayArea'); const blockersArea=byId('blockersArea'); const emailPreview=byId('emailPreview'); const folderChip=byId('folderChip');
    tagDate.value=todayISO; function fillPersonSelect(){ personSelect.innerHTML=''; state.members.forEach(m=>{ const o=document.createElement('option'); o.value=m.id; o.textContent=m.name; personSelect.appendChild(o); }); } fillPersonSelect();
    modeSelect.addEventListener('change', ()=>{ personWrap.style.display = modeSelect.value==='person' ? '' : 'none'; buildPreview(); });
    personSelect.addEventListener('change', buildPreview); tagDate.addEventListener('change', ()=>{ loadDraft(); buildPreview(); });
    function loadDraft(){ try{ const map=loadLS(TAGUP_KEY,'{}')||{}; const key=tagDate.value||todayISO; const d=map[key]; if(d){ modeSelect.value=d.mode||'team'; personWrap.style.display=d.mode==='person'? '':'none'; if(d.person_id) personSelect.value=d.person_id; toInput.value=d.to||''; ccInput.value=d.cc||''; yesterdayArea.value=d.yesterday||''; todayArea.value=d.today||''; blockersArea.value=d.blockers||''; } }catch(_){ } }
    function saveDraft(show){ try{ const map=loadLS(TAGUP_KEY,'{}')||{}; const key=tagDate.value||todayISO; map[key]={ mode:modeSelect.value, person_id:personSelect.value||'', to:toInput.value.trim(), cc:ccInput.value.trim(), yesterday:yesterdayArea.value.trim(), today:todayArea.value.trim(), blockers:blockersArea.value.trim() }; saveLS(TAGUP_KEY,map); if(show){ const s=document.createElement('span'); s.className='chip'; s.textContent='Saved'; emailPreview.parentNode.insertBefore(s,emailPreview); setTimeout(()=>s.remove(),1200); } }catch(_){ } }
    byId('btnSaveDraft').addEventListener('click', ()=>saveDraft(true));
    function summarize(memberId, iso){ const y=new Date(iso); y.setDate(y.getDate()-1); const yISO=fmtDate(y); const m=state.members.find(mm=>mm.id===memberId); const tasks=state.tasks.filter(t=>!memberId||t.assignee_id===memberId); const yDone=tasks.filter(t=>t.status==='done'&&(t.due_date===yISO||!t.due_date)); const yProg=tasks.filter(t=>(t.status==='in_progress'||t.status==='review')&&(t.start_date? t.start_date<=yISO : true)); const todayDue=tasks.filter(t=>t.due_date===iso); const todayAct=tasks.filter(t=>(t.status==='in_progress'||t.status==='review')); const blocked=tasks.filter(t=>t.status==='blocked'); const titles=a=>a.map(t=>t.title).slice(0,8).join('; '); const yText=[ yDone.length?`Completed: ${titles(yDone)}`:'', yProg.length?`Progress: ${titles(yProg)}`:'' ].filter(Boolean).map(s=>'- '+s).join('\n'); const tText=[ todayDue.length?`Due today (${todayDue.length}): ${titles(todayDue)}`:'', todayAct.length?`Active: ${titles(todayAct)}`:'' ].filter(Boolean).map(s=>'- '+s).join('\n'); const bText=blocked.length?`Blocked (${blocked.length}): ${titles(blocked)}`:''; return {name:m?m.name:'Team',yText,tText,bText}; }
    byId('btnAutofill').addEventListener('click', ()=>{ const iso=tagDate.value||todayISO; const mId = modeSelect.value==='person'? personSelect.value : ''; const s=summarize(mId,iso); yesterdayArea.value=s.yText; todayArea.value=s.tText; blockersArea.value=s.bText; saveDraft(true); buildPreview(); });
    function buildEmailParts(){ const iso=tagDate.value||todayISO; const mode=modeSelect.value; const who=(mode==='person')?(state.members.find(m=>m.id===personSelect.value)?.name||'Member'):'Team'; const subject=`Daily Scrum Tag-Up – ${who} – ${iso}`; const to=toInput.value.trim(); const cc=ccInput.value.trim(); const body=`Yesterday:\n${yesterdayArea.value.trim()||'-'}\n\nToday:\n${todayArea.value.trim()||'-'}\n\nBlockers:\n${blockersArea.value.trim()||'-'}`; return {subject,to,cc,body,full:`SUBJECT: ${subject}\nTO: ${to}\nCC: ${cc}\n\nBODY:\n${body}`}; }
    function buildPreview(){ emailPreview.textContent=buildEmailParts().full; }
    byId('btnBuildEmail').addEventListener('click', buildPreview);
    byId('btnDownloadTxt').addEventListener('click', ()=>{ const parts=buildEmailParts(); const blob=new Blob([parts.full],{type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`Daily_Tag-Up_${tagDate.value||todayISO}.txt`; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500); });

    // ===== File System Access + SharePoint subfolders =====
    const fsa = { supported: !!(window.showDirectoryPicker && window.FileSystemHandle) };
    // IndexedDB to store folder handle
    let db; function dbOpen(){ return new Promise((res,rej)=>{ const req=indexedDB.open('DTDASH_V6_DB',1); req.onupgradeneeded=(e)=>{ e.target.result.createObjectStore('kv'); }; req.onsuccess=(e)=>{ db=e.target.result; res(); }; req.onerror=()=>rej(req.error); }); }
    async function dbPut(key,val){ await dbOpen(); await new Promise((res,rej)=>{ const tx=db.transaction('kv','readwrite'); tx.objectStore('kv').put(val,key); tx.oncomplete=res; tx.onerror=()=>rej(tx.error); }); }
    async function dbGet(key){ await dbOpen(); return await new Promise((res,rej)=>{ const tx=db.transaction('kv','readonly'); const r=tx.objectStore('kv').get(key); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); }); }

    async function ensureDaySubfolder(rootHandle, iso){ // creates YYYY-MM-DD folder
      const name = iso; try{ const dayHandle = await rootHandle.getDirectoryHandle(name, { create: true }); return dayHandle; }catch(_){ return rootHandle; }
    }
    function setFolderChips(handle){ const name = handle? (handle.name || '(chosen)') : '(not set)'; folderChip.textContent = 'Folder: '+name; byId('teamFolderChip').textContent = 'Folder: '+name; byId('cfgFolderName').textContent = name; }

    async function pickFolder(){ if(!fsa.supported){ alert('Your browser does not support the File System Access API. Use Team Dashboard → Load JSONs (fallback).'); return null; } const handle = await window.showDirectoryPicker({mode:'readwrite'}); await verifyPerm(handle); await dbPut('sharedDir', handle); setFolderChips(handle); return handle; }
    async function verifyPerm(handle){ const opts={mode:'readwrite'}; if((await handle.queryPermission(opts))==='granted') return; if((await handle.requestPermission(opts))!=='granted') throw new Error('Permission denied'); }
    async function getStoredHandle(){ try{ const h = await dbGet('sharedDir'); if(h){ await verifyPerm(h); return h; } }catch(_){ } return null; }

    byId('btnEnsureDay').addEventListener('click', async ()=>{ try{ let h=await getStoredHandle(); if(!h) h=await pickFolder(); const day = await ensureDaySubfolder(h, tagDate.value||todayISO); setFolderChips(h); const s=document.createElement('span'); s.className='chip'; s.textContent='Day folder ready: '+day.name; emailPreview.parentNode.insertBefore(s,emailPreview); setTimeout(()=>s.remove(),1500); }catch(_){ alert('Could not ensure subfolder. Pick a folder in Config or Team Dashboard.'); } });

    async function submitToFolder(){ try{ let h=await getStoredHandle(); if(!h) h=await pickFolder(); const iso=tagDate.value||todayISO; const sub=await ensureDaySubfolder(h, iso); await verifyPerm(sub); const data=await buildSubmissionObject(); const fname=await makePersonalFilename(iso); const fh=await sub.getFileHandle(fname,{create:true}); const w=await fh.createWritable(); await w.write(new Blob([JSON.stringify(data,null,2)],{type:'application/json'})); await w.close(); setFolderChips(h); const s=document.createElement('span'); s.className='chip'; s.textContent='Submitted ✓'; emailPreview.parentNode.insertBefore(s,emailPreview); setTimeout(()=>s.remove(),1200); }catch(_){ alert('Submit failed. If on Firefox or a locked-down browser, use Download .txt or Team → Load JSONs (fallback).'); } }
    byId('btnSubmitFolder').addEventListener('click', submitToFolder);

    async function makePersonalFilename(iso){ const short=(cfg.shortId||'').trim(); const name=(cfg.displayName||'Member').replace(/\s+/g,''); return `tagup_${short||name}_${iso}.json`; }
    async function buildSubmissionObject(){ const iso=tagDate.value||todayISO; const mode=modeSelect.value; const pid=(mode==='person')?(personSelect.value||''):''; const mname=(mode==='person')?(state.members.find(m=>m.id===pid)?.name||cfg.displayName||'Member'):(cfg.displayName||'Team'); return {type:'daily_tagup',version:2,date:iso,mode,member_id:pid,member_name:mname,to:toInput.value.trim(),cc:ccInput.value.trim(),yesterday:yesterdayArea.value.trim(),today:todayArea.value.trim(),blockers:blockersArea.value.trim()}; }

    // ===== Team Dashboard (read submissions + risks + roll-up) =====
    const teamTableBody = byId('teamTable').querySelector('tbody');
    function renderTeamTable(subs){ teamTableBody.innerHTML=''; const byMember={}; subs.forEach(s=>{ byMember[s.member_name||s.member_id||'Member']=s; }); const expected=state.members.map(m=>m.name); const seen=new Set(Object.keys(byMember)); let counts={in_progress:0,blocked:0,review:0,done:0,backlog:0}; // roll-up from local tasks (approx)
      state.tasks.forEach(t=>{ counts[t.status]=(counts[t.status]||0)+1; });
      byId('teamSummaryCounts').textContent = `Submissions: ${expected.filter(n=>seen.has(n)).length}/${expected.length} • Tasks — In Progress: ${counts.in_progress||0}, Blocked: ${counts.blocked||0}, Review: ${counts.review||0}, Done: ${counts.done||0}`;
      expected.forEach(name=>{ const s=byMember[name]; const tr=document.createElement('tr'); if(s){ tr.innerHTML=`<td>${esc(name)}</td><td>${esc(s.yesterday||'-')}</td><td>${esc(s.today||'-')}</td><td>${esc(s.blockers||'-')}</td><td>${esc(s.date||'')}</td><td class='ok'>Received</td>`; } else { tr.innerHTML=`<td>${esc(name)}</td><td class='note'>—</td><td class='note'>—</td><td class='note'>—</td><td>${esc(tagDate.value||todayISO)}</td><td class='warn'>Missing</td>`; } teamTableBody.appendChild(tr); }); }

    async function refreshFolder(){ try{ let h=await getStoredHandle(); if(!h){ setFolderChips(null); return; } setFolderChips(h); const iso=tagDate.value||todayISO; const day=await ensureDaySubfolder(h, iso); const subs=[]; for await (const entry of day.values()){ if(entry.kind==='file' && /\.json$/i.test(entry.name)){ const file=await entry.getFile(); try{ const obj=JSON.parse(await file.text()); if(obj && obj.type==='daily_tagup' && obj.date===iso) subs.push(obj); }catch(_){ } } } renderTeamTable(subs); }catch(_){ renderTeamTable([]); } }
    byId('btnRefreshFolder').addEventListener('click', refreshFolder);
    byId('btnPickFolder').addEventListener('click', pickFolder);

    byId('multiJson').addEventListener('change', async ()=>{ const iso=tagDate.value||todayISO; const subs=[]; for(const f of byId('multiJson').files){ try{ const obj=JSON.parse(await f.text()); if(obj && obj.type==='daily_tagup' && obj.date===iso) subs.push(obj); }catch(_){ } } renderTeamTable(subs); byId('multiJson').value=''; });

    function buildTeamTxt(){ const rows=teamTableBody.querySelectorAll('tr'); const iso=tagDate.value||todayISO; let roll=`Summary (${iso})\n`; const tsc=byId('teamSummaryCounts').textContent||''; if(tsc) roll+=tsc+"\n"; let txt=`SUBJECT: Daily Scrum Tag-Up – Team – ${iso}\n\nBODY:\n${roll}\n`; rows.forEach(r=>{ const c=r.querySelectorAll('td'); if(c.length<6) return; const name=c[0].textContent.trim(); const status=c[5].textContent.trim(); if(status==='Received'){ const y=c[1].textContent.trim()||'-'; const t=c[2].textContent.trim()||'-'; const b=c[3].textContent.trim()||'-'; txt+=`\n${name}\nYesterday:\n${y}\n\nToday:\n${t}\n\nBlockers:\n${b}\n`; } else { txt+=`\n${name}\n(Missing submission)\n`; } }); // Append risks table brief
      if(risks.length){ txt+="\nRisks & Impediments:\n"; risks.forEach((r,i)=>{ txt+=`- [${r.severity||'M'}] ${r.title||'Risk'} — Owner: ${r.owner||'-'} — Status: ${r.status||'-'} — Mitigation: ${r.mitigation||'-'}\n`; }); }
      return txt; }
    byId('btnBuildTeamTxt').addEventListener('click', ()=>{ byId('teamTxtPreview').textContent=buildTeamTxt(); });
    byId('btnDownloadTeamTxt').addEventListener('click', ()=>{ const txt=buildTeamTxt(); const url=URL.createObjectURL(new Blob([txt],{type:'text/plain'})); const a=document.createElement('a'); a.href=url; a.download=`Team_Tag-Up_${tagDate.value||todayISO}.txt`; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500); });

    // ===== Risks Table =====
    const riskBody = byId('riskTable').querySelector('tbody');
    function renderRisks(){ riskBody.innerHTML=''; risks.forEach((r,idx)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td contenteditable data-field='title'>${esc(r.title||'')}</td><td><select data-field='severity'><option ${r.severity==='L'?'selected':''}>L</option><option ${r.severity==='M'?'selected':''}>M</option><option ${r.severity==='H'?'selected':''}>H</option></select></td><td contenteditable data-field='owner'>${esc(r.owner||'')}</td><td contenteditable data-field='status'>${esc(r.status||'Open')}</td><td contenteditable data-field='mitigation'>${esc(r.mitigation||'')}</td><td><button class='btn' data-act='del' data-idx='${idx}'>Delete</button></td>`; riskBody.appendChild(tr); }); }
    function persistRisks(){ saveLS(RISK_KEY,risks); }
    byId('btnAddRisk').addEventListener('click', ()=>{ risks.push({title:'',severity:'M',owner:'',status:'Open',mitigation:''}); persistRisks(); renderRisks(); });
    riskBody.addEventListener('input', (e)=>{ const tr=e.target.closest('tr'); if(!tr) return; const idx=[...riskBody.children].indexOf(tr); const field=e.target.getAttribute('data-field'); if(!field) return; if(e.target.tagName==='SELECT') risks[idx][field]=e.target.value; else risks[idx][field]=e.target.textContent.trim(); persistRisks(); });
    riskBody.addEventListener('click', (e)=>{ const btn=e.target.closest('button[data-act="del"]'); if(btn){ const i=+btn.getAttribute('data-idx'); risks.splice(i,1); persistRisks(); renderRisks(); } });

    // ===== Milestones =====
    const msList=byId('msList');
    function renderMilestones(){ msList.innerHTML=''; milestones.forEach((m,i)=>{ const pct=Math.max(0,Math.min(100, Number(m.percent||0))); const card=document.createElement('div'); card.className='ms-card'; const statusColor=pct>=100?'var(--ok)':(m.finish_date && (new Date(m.finish_date)<new Date()) && pct<100 ? 'var(--warn)':'#93c5fd'); card.innerHTML=`<div style="display:flex;justify-content:space-between;gap:8px;align-items:center"><strong>${esc(m.name||'Milestone')}</strong><span class='note'>${esc(m.owner||'')}</span></div><div class='note'>${esc(m.start_date||'')} → ${esc(m.finish_date||'')} • <span style='color:${statusColor}'>${pct}%</span></div><div class='bar' style='margin:6px 0 8px'><span style='width:${pct}%'></span></div><div class='note'>${esc(m.notes||'')}</div><div style='margin-top:8px;display:flex;gap:6px;flex-wrap:wrap'><button class='btn' data-ms='edit' data-idx='${i}'>Edit</button><button class='btn' data-ms='del' data-idx='${i}'>Delete</button></div>`; msList.appendChild(card); }); }
    function persistMs(){ saveLS(MS_KEY,milestones); }
    byId('btnAddMs').addEventListener('click', ()=>{ const name=prompt('Milestone name?'); if(!name) return; milestones.push({name, start_date:todayISO, finish_date:'', percent:0, owner:'', notes:''}); persistMs(); renderMilestones(); });
    msList.addEventListener('click', (e)=>{ const btn=e.target.closest('button[data-ms]'); if(!btn) return; const i=+btn.getAttribute('data-idx'); const m=milestones[i]; if(btn.getAttribute('data-ms')==='del'){ milestones.splice(i,1); persistMs(); renderMilestones(); } else { const name=prompt('Name', m.name||''); const start=prompt('Start (YYYY-MM-DD)', m.start_date||''); const finish=prompt('Finish (YYYY-MM-DD)', m.finish_date||''); const pct=prompt('% complete (0-100)', m.percent||0); const owner=prompt('Owner', m.owner||''); const notes=prompt('Notes', m.notes||''); milestones[i]={name,start_date:start,finish_date:finish,percent:Number(pct)||0,owner,notes}; persistMs(); renderMilestones(); } });
    byId('btnExportMs').addEventListener('click', ()=>{ const url=URL.createObjectURL(new Blob([JSON.stringify(milestones,null,2)],{type:'application/json'})); const a=document.createElement('a'); a.href=url; a.download='milestones.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500); });
    byId('fileImportMs').addEventListener('change', ()=>{ const f=byId('fileImportMs').files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const arr=JSON.parse(r.result); if(Array.isArray(arr)) { milestones=arr; persistMs(); renderMilestones(); } }catch(_){ } }; r.readAsText(f); byId('fileImportMs').value=''; });

    // ===== Config =====
    const cfgDisplayName=byId('cfgDisplayName'); const cfgShortId=byId('cfgShortId'); const cfgSaved=byId('cfgSaved');
    function hydrateConfigUI(){ cfgDisplayName.value=cfg.displayName||''; cfgShortId.value=cfg.shortId||''; getStoredHandle().then(h=>setFolderChips(h||null)).catch(()=>setFolderChips(null)); }
    byId('cfgSave').addEventListener('click', ()=>{ const obj={ displayName: cfgDisplayName.value.trim(), shortId: cfgShortId.value.trim() }; saveLS(CFG_KEY,obj); cfgSaved.style.display='inline-flex'; setTimeout(()=>cfgSaved.style.display='none',1200); });
    byId('cfgPickFolder').addEventListener('click', pickFolder);

    // ===== Render All =====
    function renderAll(){ renderMembers(byId('memberStrip')); renderKanban(); renderBacklog(); renderCalendar(); renderRisks(); buildPreview(); }

    // ===== Delegated click to open task by card/event =====
    document.addEventListener('click', (e)=>{ const el=e.target.closest && (e.target.closest('.card[data-task-id]')||e.target.closest('.event[data-task-id]')); if(el){ const id=el.getAttribute('data-task-id'); const t=state.tasks.find(x=>x.id===id); if(t) openModal(t); } });

    // ===== Calendar nav =====
    byId('calPrev').addEventListener('click', ()=>{ calCursor=new Date(calCursor.getFullYear(),calCursor.getMonth()-1,1); renderAll(); });
    byId('calNext').addEventListener('click', ()=>{ calCursor=new Date(calCursor.getFullYear(),calCursor.getMonth()+1,1); renderAll(); });
    byId('calToday').addEventListener('click', ()=>{ const n=new Date(); calCursor=new Date(n.getFullYear(),n.getMonth(),1); renderAll(); });

    // Initial
    renderAll();
    activateView((location.hash||'#dashboard').slice(1));
    statusBadge.textContent='ready'; statusBadge.classList.remove('loading'); statusBadge.classList.add('ready');
  }catch(err){ /* silent */ }
});
</script>
</body>
</html>
